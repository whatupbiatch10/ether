<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="//cdn.rawgit.com/twbs/bootstrap/v4.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropper/2.3.4/cropper.min.css" rel="stylesheet">
    <link href="dist/css/bootstrap-colorpicker.css" rel="stylesheet">
    <style>
        .frame {
            width: 600px;
            height: 800px;
            text-align: center;
            position: relative;
        }
        .frame img {
            max-width: 100%;
        }
        .cardborder {
            z-index: -1;
            width: 591px;
            height: 769px;
            position: absolute;
            fill: rgb(227, 228, 230);
            /* stroke: black; */
            stroke-width: 2px;
            left: 5px;
        }
        .internalborder {
            z-index: -2;
            width: 458px;
            height: 600px;
            position: absolute;
            fill: white;
            stroke: black;
            stroke-width: 2px;
            left: 76px;
            top: 147px;
            object-fit: cover;
            object-position: center;
        }
        input[type=file] {
            padding: 10px;
            background: #2d2d2d;
        }
        .page {
            margin: 1em auto;
            max-width: 768px;
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
            height: 100%;
        }
        .box {
            padding: 0.5em;
            width: 100%;
            margin: 0.5em;
        }

        .box-2 {
            padding: 0.5em;
            width: calc(100%/2 - 1em);
        }

        .options label,
        .options input {
            width: 4em;
            padding: 0.5em 1em;
        }

        .btn {
            background: white;
            color: black;
            border: 1px solid black;
            padding: 0.5em 1em;
            text-decoration: none;
            margin: 0.8em 0.3em;
            display: inline-block;
            cursor: pointer;
        }

        .hide {
            display: none;
        }

        img {
            max-width: 100%;
        }
    </style>
</head>

<body>


    <main>
        <div class="container">
            <div class="jumbotron">
                <h1>Bootstrap Colorpicker Demo</h1>
                <input id="demo" type="text" class="form-control" value="rgb(255, 128, 0)" />
                <!-- <button id="colorbicker">Choose Color</button> -->
            </div>
            <div id="something">

                <div class="frame" id="cardboard">
                    <svg class="cardborder">
                        <use xlink:href="./sprites.svg#main_border"></use>
                    </svg>
                    <img src="./cardbordernew.png" alt="cardborder">
                    <!-- <input type='file' onchange="readURL(this);" /> -->
                    <!-- <img class="internalborder" src="./internalborder.png" alt="internalborder"> -->
                    <div class="box-2 img-result hide">
                        <!-- result of crop -->
                        <img class="cropped internalborder" src="" alt="">
                    </div>


                </div>
            </div>
        </div>
        <main class="page">

            <!-- input file -->
            <div class="box">
                <input type="file" id="file-input">
            </div>
            <!-- leftbox -->
            <div class="box-2">
                <div class="result"></div>
            </div>
            <!--rightbox-->
            <div class="box-2 img-result hide">
                <!-- result of crop -->
                <img class="cropped" src="" alt="">
            </div>
            <!-- input file -->
            <div class="box">
                <div class="options hide">
                    <label> Width</label>
                    <input type="number" class="img-w" value="300" min="100" max="1200" />
                </div>
                <!-- save btn -->
                <button class="btn save hide">Save</button>
                <!-- download btn -->
                <!-- <a href="" class="btn download">Download</a> -->
                <button id="dwndiv" onClick="downloadimg()">Download</button>
            </div>
        </main>
        <img id="pg" />
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="//cdn.rawgit.com/twbs/bootstrap/v4.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="dist/js/bootstrap-colorpicker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/0.8.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"
        integrity="sha256-c3RzsUWg+y2XljunEQS0LqWdQ04X1D3j22fd/8JCAKw=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"
        integrity="sha256-htuR1Owx8i9hm4h4Y4d/FjlPLoj2teQmhJ5WnNSo3w0=" crossorigin="anonymous"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tinyColorPicker/1.1.1/jqColorPicker.min.js"></script> -->

    <script>
        $(function () {
            // Basic instantiation:
            //   $('#colorbicker').colorPicker({
            //         renderCallback: function(colors, mode){

            //         },
            //     });
            $('#demo').colorpicker();

            // Example using an event, to change the color of the .jumbotron background:
            $('#demo').on('colorpickerChange', function (event) {
                $('.jumbotron').css('background-color', event.color.toString());
                $('.cardborder').css('fill', event.color.toString());
            });
        });

        //     function readURL(input) {
        //     if (input.files && input.files[0]) {
        //         var reader = new FileReader();

        //         reader.onload = function (e) {
        //             $('.internalborder')
        //                 .attr('src', e.target.result);
        //         };

        //         reader.readAsDataURL(input.files[0]);
        //     }
        // }    

        // vars
        let result = document.querySelector('.result'),
            img_result = document.querySelector('.img-result'),
            img_w = document.querySelector('.img-w'),
            img_h = document.querySelector('.img-h'),
            options = document.querySelector('.options'),
            save = document.querySelector('.save'),
            cropped = document.querySelector('.cropped'),
            // dwn = document.querySelector('.download'),
            upload = document.querySelector('#file-input'),
            cropper = '';

        // on change show image with crop options
        upload.addEventListener('change', (e) => {
            if (e.target.files.length) {
                // start file reader
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (e.target.result) {
                        // create new image
                        let img = document.createElement('img');
                        img.id = 'image';
                        img.src = e.target.result
                        // clean result before
                        result.innerHTML = '';
                        // append new image
                        result.appendChild(img);
                        // show save btn and options
                        save.classList.remove('hide');
                        options.classList.remove('hide');
                        // init cropper
                        cropper = new Cropper(img);
                    }
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        var temp_canvas;
        // save on click
        save.addEventListener('click', (e) => {
            e.preventDefault();
            // get result to data uri
            let imgSrc = cropper.getCroppedCanvas({
                width: img_w.value // input value
            }).toDataURL();
            // remove hide class of img
            cropped.classList.remove('hide');
            img_result.classList.remove('hide');
            // show image cropped
            cropped.src = imgSrc;
            var element = $("#cardboard"); // global variable
            var getCanvas; // global variable

            html2canvas(element, {
                onrendered: function (canvas) {
                    $("#copyDiv").append(canvas);
                    getCanvas = canvas;
                    temp_canvas = canvas;
                    $('#pg').attr('src', canvas.toDataURL());
                    
                }
            });

            //   dwn.classList.remove('hide');
            //   dwn.download = 'imagename.png';
            //   dwn.setAttribute('href',imgSrc);
        });

        function downloadimg() {
            temp_canvas.toBlob(function (blob) {
                        saveAs(blob, "pretty image.png");
                    });
        }
    </script>
</body>

</html>